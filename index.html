<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>å®‰å®‰ä¾†æ‰¾å¤§ä¸åŒ</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f0f4f8;
            margin: 0;
            padding: 0;
            height: 100svh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; 
        }

        .game-container {
            background: white;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 8px;
            position: relative;
        }

        /* === é ­éƒ¨ (Header) === */
        .header {
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            margin-bottom: 8px;
            height: 40px;
        }

        .title { font-weight: bold; font-size: 16px; }
        .stats { font-size: 13px; display: flex; gap: 8px; }

        /* === éŠæˆ²å€ (Board) === */
        .board {
            flex: 1;
            min-height: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            width: 100%;
            position: relative;
        }

        .image-wrapper {
            position: relative;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
        }

        .image-inner {
            position: relative;
            display: inline-block;
            line-height: 0;
        }

        .game-img {
            display: block;
            object-fit: contain;
        }

        /* æ¨™è¨˜é» */
        .marker {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid #ff4757;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            box-shadow: 0 0 0 2px white, 0 0 10px rgba(255, 71, 87, 0.5);
            animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes pop {
            from { transform: translate(-50%, -50%) scale(0); }
            to { transform: translate(-50%, -50%) scale(1); }
        }

        /* === åº•éƒ¨ (Footer) === */
        .footer {
            flex-shrink: 0;
            height: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #eee;
            padding-top: 6px;
            margin-top: 6px;
            gap: 5px;
        }

        button {
            padding: 4px 10px;
            border-radius: 20px;
            border: 1px solid #ccc;
            background: #f8f9fa;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        button:active { transform: scale(0.95); }
        button:disabled { opacity: 0.5; }

        /* éŸ³æ¨‚æŒ‰éˆ•å•Ÿç”¨ç‹€æ…‹ */
        button.music-on {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #0d47a1;
        }

        /* ================================================= */
        /* ğŸ“± æ¨¡å¼ 1ï¼šæ‰‹æ©Ÿç›´å‘ */
        /* ================================================= */
        @media (orientation: portrait) {
            body {
                height: auto;
                min-height: 100svh;
                overflow-y: auto;
                display: block;
            }
            .game-container { height: auto; min-height: 100svh; }
            .board { flex-direction: column; height: auto; flex: none; }
            .image-wrapper { width: 100%; height: auto; flex: none; margin-bottom: 10px; }
            .game-img { width: 100%; height: auto; }
        }

        /* ================================================= */
        /* ğŸ“± æ¨¡å¼ 2ï¼šæ‰‹æ©Ÿæ©«å‘ */
        /* ================================================= */
        @media (orientation: landscape) {
            .game-container { padding: 4px 10px; }
            .header, .footer { height: 30px; margin: 2px 0; font-size: 12px; }
            .board { flex-direction: row; align-items: center; height: 100%; }
            .image-wrapper {
                height: 100%; width: auto; background: transparent; border: none;
                max-width: 48vw;
            }
            .image-inner { height: 100%; width: auto; }
            .game-img { height: 100%; width: auto; max-width: 100%; }
            .title span:first-child { display: none; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <div class="title">
                <span>ğŸŒŸ</span> æ‰¾ä¸åŒ
                <span style="background:#eee; padding:2px 6px; border-radius:10px; font-size:12px" id="levelName">L1</span>
            </div>
            <div class="stats">
                <span>â± <b id="time">120</b></span>
                <span>âœ… <b id="found">0</b>/<span id="total">5</span></span>
                <select id="levelSelect">
                    <option value="0">1</option>
                    <option value="1">2</option>
                    <option value="2">3</option>
                </select>
            </div>
        </div>

        <div class="board">
            <div class="image-wrapper">
                <div class="image-inner" id="image-left">
                    <img id="image-left-img" class="game-img" src="" alt="Left">
                </div>
            </div>
            <div class="image-wrapper">
                <div class="image-inner" id="image-right">
                    <img id="image-right-img" class="game-img" src="" alt="Right">
                </div>
            </div>
        </div>

        <div class="footer">
            <button id="btnMusic">ğŸ”‡ éŸ³æ¨‚</button>
            <div id="message" style="flex:1; font-size:12px; color:#666; text-align:center;">é–‹å§‹éŠæˆ²</div>
            <button id="btnHint">ğŸ’¡ æç¤º</button>
            <button id="btnRestart">ğŸ”„ é‡ä¾†</button>
            <button id="btnShowAll">ğŸ‘ï¸ è§£ç­”</button>
        </div>
    </div>

    <script>
        // === éŠæˆ²è³‡æ–™ ===
        const levels = [
            {
                id: 1, name: "L1: æ£®æ—", img1: "S__52166671.jpg", img2: "S__52166671_1.png",
                diffs: [{x:0.5675,y:0.3207,r:0.08},{x:0.4029,y:0.2252,r:0.08},{x:0.7622,y:0.2259,r:0.08},{x:0.2641,y:0.915,r:0.08},{x:0.4716,y:0.872,r:0.08}],
                hints: ["æ‰‹å¥—é¡è‰²", "å¸½å­æ˜Ÿæ˜Ÿ", "æ°£çƒæ£’", "é‹å¸¶", "åœæ¬„"]
            },
            {
                id: 2, name: "L2: å±•å ´", img1: "S__52166670.jpg", img2: "S__52166670_1.jpg",
                diffs: [{x:0.4018,y:0.875,r:0.09},{x:0.6096,y:0.8584,r:0.09},{x:0.694,y:0.292,r:0.09},{x:0.5612,y:0.0254,r:0.09},{x:0.6175,y:0.1641,r:0.09}],
                hints: ["æ‰£å­", "åœ°æ¿äº®é»", "çœ¼ç›ç·šæ¢", "èƒŒæ™¯ç·šæ¢", "é«®åœˆ"]
            },
            {
                id: 3, name: "L3: æ´—è»Š", img1: "S__52166669.jpg", img2: "S__52166669_1.jpg",
                diffs: [{x:0.1066,y:0.3928,r:0.08},{x:0.3843,y:0.3627,r:0.08},{x:0.5088,y:0.9112,r:0.08},{x:0.6434,y:0.059,r:0.08},{x:0.2941,y:0.5997,r:0.08}],
                hints: ["è»Šç‡ˆåå…‰", "è»Šçª—é»‘ç·š", "åœ°ä¸Šæ³¡æ³¡", "ç»ç’ƒåå…‰", "æµ·ç¶¿é¡è‰²"]
            }
        ];

        let curLv = 0, found = [], timeLeft = 120, timer = null, isOver = false, hintIdx = 0;
        const el = (id) => document.getElementById(id);

        // === ğŸµ éŸ³æ¨‚èˆ‡éŸ³æ•ˆç³»çµ± (ä½¿ç”¨ Web Audio API ç”Ÿæˆï¼Œç„¡éœ€å¤–éƒ¨æª”æ¡ˆ) ===
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let bgmOscillators = []; // å­˜æ”¾ BGM çš„éŸ³æº
        let isMusicPlaying = false;

        // 1. æ’­æ”¾å–®æ¬¡éŸ³æ•ˆ (Hit, Win, Lose)
        const playSound = (type) => {
            if (audioCtx.state === 'suspended') audioCtx.resume(); // ç¢ºä¿éŸ³è¨Šå•Ÿå‹•
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.connect(g);
            g.connect(audioCtx.destination);

            const now = audioCtx.currentTime;
            
            if (type === "win") {
                // å‹åˆ©éŸ³æ•ˆï¼šä¸Šå‡çš„ç¶éŸ³
                osc.type = "triangle";
                osc.frequency.setValueAtTime(523.25, now); // C5
                osc.frequency.setValueAtTime(659.25, now + 0.1); // E5
                osc.frequency.setValueAtTime(783.99, now + 0.2); // G5
                osc.frequency.setValueAtTime(1046.50, now + 0.3); // C6
                g.gain.setValueAtTime(0.1, now);
                g.gain.linearRampToValueAtTime(0, now + 0.6);
                osc.start(now);
                osc.stop(now + 0.6);
            } else if (type === "hit") {
                // ç­”å°éŸ³æ•ˆï¼šæ¸…è„†çš„é«˜éŸ³
                osc.type = "sine";
                osc.frequency.setValueAtTime(880, now);
                g.gain.setValueAtTime(0.1, now);
                g.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else {
                // æç¤ºæˆ–å…¶ä»–ï¼šä½éŸ³
                osc.type = "sine";
                osc.frequency.setValueAtTime(300, now);
                g.gain.setValueAtTime(0.1, now);
                g.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            }
        };

        // 2. èƒŒæ™¯éŸ³æ¨‚ (BGM) - ç”Ÿæˆç°¡å–®çš„å¾ªç’°æ—‹å¾‹
        function startBGM() {
            if (bgmOscillators.length > 0) return; // å·²ç¶“åœ¨æ’­æ”¾
            
            const createNote = (freq, startTime, duration) => {
                const osc = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.value = freq;
                osc.connect(g);
                g.connect(audioCtx.destination);
                
                // æ·¡å…¥æ·¡å‡ºè®“è²éŸ³æŸ”å’Œ
                g.gain.setValueAtTime(0, startTime);
                g.gain.linearRampToValueAtTime(0.03, startTime + 0.1); // å¾ˆå°è²ï¼Œé¿å…åµ
                g.gain.linearRampToValueAtTime(0, startTime + duration - 0.1);
                
                osc.start(startTime);
                osc.stop(startTime + duration);
                bgmOscillators.push(osc);
            };

            // ç°¡å–®çš„æ—‹å¾‹å¾ªç’° (C Major)
            const melody = [523.25, 659.25, 783.99, 659.25, 523.25, 392.00, 329.63, 392.00]; 
            const interval = 0.5; // æ¯å€‹éŸ³çš„é–“éš”
            
            const loop = () => {
                if (!isMusicPlaying) return;
                const now = audioCtx.currentTime;
                melody.forEach((freq, index) => {
                    createNote(freq, now + index * interval, interval);
                });
                // éè¿´å‘¼å«è‡ªå·±ï¼Œå¯¦ç¾å¾ªç’°
                setTimeout(loop, melody.length * interval * 1000); 
            };
            loop();
        }

        function stopBGM() {
            bgmOscillators.forEach(osc => {
                try { osc.stop(); } catch(e){}
            });
            bgmOscillators = [];
        }

        // éŸ³æ¨‚é–‹é—œæŒ‰éˆ•é‚è¼¯
        el("btnMusic").onclick = () => {
            isMusicPlaying = !isMusicPlaying;
            const btn = el("btnMusic");
            if (isMusicPlaying) {
                btn.innerText = "ğŸµ éŸ³æ¨‚";
                btn.classList.add("music-on");
                if (audioCtx.state === 'suspended') audioCtx.resume();
                startBGM();
            } else {
                btn.innerText = "ğŸ”‡ éŸ³æ¨‚";
                btn.classList.remove("music-on");
                stopBGM();
            }
        };

        // === éŠæˆ²æ ¸å¿ƒé‚è¼¯ ===

        function loadLevel(idx) {
            curLv = idx;
            const lv = levels[idx];
            el("image-left-img").src = lv.img1;
            el("image-right-img").src = lv.img2;
            el("levelName").innerText = lv.name;
            el("total").innerText = lv.diffs.length;
            found = lv.diffs.map(() => false);
            hintIdx = 0;
            startGame();
        }

        function startGame() {
            document.querySelectorAll(".marker").forEach(m => m.remove());
            isOver = false;
            timeLeft = 120;
            el("time").innerText = timeLeft;
            el("found").innerText = 0;
            el("message").innerText = "æ‰¾å‡º " + levels[curLv].diffs.length + " å€‹ä¸åŒ";
            el("btnShowAll").disabled = false;
            
            if (timer) clearInterval(timer);
            timer = setInterval(() => {
                timeLeft--;
                el("time").innerText = timeLeft;
                if (timeLeft <= 0) endGame(false);
            }, 1000);
        }

        // ğŸ‰ é€šé—œç‰¹æ•ˆå‡½æ•¸
        function triggerConfetti() {
            // ç™¼å°„ç¦®ç‚®ï¼(ä½¿ç”¨ canvas-confetti åº«)
            const duration = 2000;
            const end = Date.now() + duration;

            (function frame() {
                // å…©é‚Šå™´å°„
                confetti({
                    particleCount: 5,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 },
                    colors: ['#ff0000', '#00ff00', '#0000ff']
                });
                confetti({
                    particleCount: 5,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 },
                    colors: ['#ff0000', '#00ff00', '#0000ff']
                });

                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            }());
        }

        function endGame(win) {
            if (isOver) return;
            isOver = true;
            clearInterval(timer);
            el("message").innerText = win ? "ğŸ‰ éé—œï¼" : "æ™‚é–“åˆ°";
            
            if (win) {
                playSound("win");
                triggerConfetti(); // è§¸ç™¼å½©å¸¶ç‰¹æ•ˆ
                
                setTimeout(() => {
                    if (curLv < levels.length - 1) {
                        el("levelSelect").value = curLv + 1;
                        loadLevel(curLv + 1);
                    } else {
                        el("message").innerText = "ğŸ† å…¨ç ´é—œï¼å¤ªå¼·äº†ï¼";
                        // å…¨ç ´é—œå†ä¾†ä¸€æ¬¡å¤§ç¦®ç‚®
                        confetti({ particleCount: 150, spread: 100, origin: { y: 0.6 } });
                    }
                }, 2500); // å»¶é•·ä¸€é»æ™‚é–“è®“ç‰¹æ•ˆè·‘å®Œ
            }
        }

        function mark(normX, normY) {
            const addMarker = (parent) => {
                const m = document.createElement("div");
                m.className = "marker";
                m.style.left = (normX * 100) + "%";
                m.style.top = (normY * 100) + "%";
                parent.appendChild(m);
            };
            addMarker(el("image-left"));
            addMarker(el("image-right"));
        }

        const clickHandler = (e) => {
            if (isOver) return;
            
            // å˜—è©¦è§£é–éŸ³è¨Šç’°å¢ƒ (iOS éœ€è¦ä½¿ç”¨è€…äº’å‹•å¾Œæ‰èƒ½æ’­æ”¾è²éŸ³)
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const wrapper = e.currentTarget;
            const img = wrapper.querySelector("img");
            if (!img) return;

            const imgRect = img.getBoundingClientRect();
            if (
                e.clientX < imgRect.left || e.clientX > imgRect.right ||
                e.clientY < imgRect.top || e.clientY > imgRect.bottom
            ) return;

            const nx = (e.clientX - imgRect.left) / imgRect.width;
            const ny = (e.clientY - imgRect.top) / imgRect.height;

            let hit = -1;
            levels[curLv].diffs.forEach((d, i) => {
                if (!found[i] && Math.hypot(nx - d.x, ny - d.y) < d.r) {
                    hit = i;
                }
            });

            if (hit >= 0) {
                found[hit] = true;
                const d = levels[curLv].diffs[hit];
                mark(d.x, d.y);
                el("found").innerText = found.filter(Boolean).length;
                playSound("hit");
                el("message").innerText = "âœ… æ‰¾åˆ°ä¸€å€‹ï¼";
                if (found.every(Boolean)) endGame(true);
            }
        };

        document.querySelectorAll(".image-wrapper").forEach(w => w.addEventListener("click", clickHandler));

        el("btnRestart").onclick = startGame;
        
        el("btnShowAll").onclick = () => {
            levels[curLv].diffs.forEach((d, i) => {
                if (!found[i]) mark(d.x, d.y);
            });
            endGame(false);
            el("btnShowAll").disabled = true;
        };

        el("btnHint").onclick = () => {
            const lv = levels[curLv];
            el("message").innerText = "æç¤º: " + lv.hints[hintIdx];
            hintIdx = (hintIdx + 1) % lv.diffs.length;
            playSound("hint");
        };

        el("levelSelect").onchange = (e) => loadLevel(parseInt(e.target.value, 10));

        loadLevel(0);
    </script>
</body>
</html>
